name: Release

on:
  push:
    branches: [ "release" ]
  pull_request:
    branches: [ "release" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6
    - uses: dtolnay/rust-toolchain@stable
    - name: Install cargo-release
      run: |
        if ! command -v cargo-release &> /dev/null; then
          echo "Installing cargo-release..."
          cargo install cargo-release
        else
          INSTALLED_VERSION=$(cargo release --version || echo "unknown")
          echo "cargo-release already installed (version: $INSTALLED_VERSION). Skipping installation."
        fi
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com" 
    - name: Run tests
      run: cargo test
    - name: Release patch version
      run: cargo publish --token ${{ secrets.CRATE_TOKEN }}